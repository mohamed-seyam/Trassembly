$NOMOD51	                    ;to suppress the pre-defined addresses by keil
$include (C8051F020.INC)		; to declare the device peripherals	with it's addresses
ORG 0H					        ; to start writing the code from the base 0


;diable the watch dog
MOV WDTCN,#11011110B ;0DEH
MOV WDTCN,#10101101B ;0ADH

; config of clock
MOV OSCICN , #14H ; 2MH clock
;config cross bar
MOV XBR0 , #00H
MOV XBR1 , #00H
MOV XBR2 , #040H  ; Cross bar enabled , weak Pull-up enabled 

;config,setup
MOV P74OUT, #00001000B
MOV P1MDOUT, #0FFh
MOV P2MDOUT, #0FFh
MOV P3MDOUT, #0FFh
MOV R0,#3
MOV R1,#3

MOV A,P5
ORL A, #00010000B
MOV P5, A

MAX EQU 10
MIN EQU 0

INIT:	
    MOV R4,#10
    MOV DPTR, #400h
    MOV A,#10
    CLR C
    SUBB A,R0
    MOVC A,@A+DPTR
    MOV P1,A
    AJMP COUNT

START: 	
    MOV R4,#10
    MOV DPTR, #400h
    AJMP COUNT

MAIN:
	DJNZ R4, COUNT
	DJNZ R0, INIT
	ACALL LED_TOGGLE
	LED_TOGGLE_END:
	AJMP RESTART
	END_COUNT:
	ACALL SWITCHS
	AJMP MAIN

LED_TOGGLE:	
    CLR A
    MOV A, P5	
    ANL A, #00010000B
    CJNE A, #00010000B, RED_ON
    RED_ON_END:
    ACALL GREEN_ON
    RET

RED_ON:			
    MOV A,P5
    ORL A, #00010000B
    MOV P5, A
    AJMP LED_TOGGLE_END

GREEN_ON:			
    MOV A,P5
    ORL A, #00100000B
    MOV P5, A
    RET

RESTART:
	MOV A,R1
	MOV R0, A
	AJMP INIT

SWITCHS:
	CLR A
	MOV A, P4
	ANL A, #00000001B
	JNZ FAST
	MOV A, P4
	ANL A, #00000010B
	JNZ MEDIUM
	MOV A, P4
	ANL A, #00000100B
	JNZ SLOW
	ACALL DEFULT_DELAY
	SKIP_SPEED:
		MOV A, P5
		ANL A, #00000001B
		JZ INCRENENT
		MOV A, P5
		ANL A, #00000010B
		JZ DECREMENT
	RET


SLOW:
	ACALL SLOW_DELAY
	AJMP SKIP_SPEED
MEDIUM:
	ACALL DEFULT_DELAY
	AJMP SKIP_SPEED
FAST:
	ACALL FAST_DELAY
	AJMP SKIP_SPEED
INCRENENT:
	CJNE R1, #MAX, DO_INCREMENT
	AJMP RESTART
	DO_INCREMENT:
        INC R1
        AJMP RESTART
	RET
DECREMENT:
	CJNE R1, #MIN, DO_DECREMENT
	AJMP RESTART
	DO_DECREMENT:
		DEC R1
		AJMP RESTART
	RET

COUNT:	CLR A
		MOVC A,@A+DPTR
		MOV P2,A
		INC DPTR
		AJMP END_COUNT

FAST_DELAY:
	MOV R7,#5
	LOOP4:MOV R6,#200
		LOOP5:MOV R5,#198
	LOOP6:DJNZ R5,LOOP6
	DJNZ R6,LOOP5
	DJNZ R7,LOOP4
	RET

DEFULT_DELAY:
	MOV R7,#10
	LOOP7:MOV R6,#200
	LOOP8:MOV R5,#198
	LOOP9:DJNZ R5,LOOP9
	DJNZ R6,LOOP8
	DJNZ R7,LOOP7
	RET

SLOW_DELAY:
	MOV R7,#20
	LOOP10:MOV R6,#200
	LOOP11:MOV R5,#198
	LOOP12:DJNZ R5,LOOP12
	DJNZ R6,LOOP11
	DJNZ R7,LOOP10
	RET

ORG 400H
DB 6FH,7FH,07H,7DH,6DH,66H,4FH,5BH,06H,3FH

END